{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "4368189678471159686"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Azure region for all resources. Defaults to the resource group location when not specified."
      }
    },
    "namePrefix": {
      "type": "string",
      "defaultValue": "flowcy",
      "minLength": 3,
      "metadata": {
        "description": "Prefix used for resource names (letters, numbers, and hyphens)."
      }
    },
    "cosmosAccountName": {
      "type": "string",
      "defaultValue": "[toLower(substring(replace(format('{0}{1}', parameters('namePrefix'), uniqueString(resourceGroup().id)), '-', ''), 0, 44))]",
      "minLength": 3,
      "metadata": {
        "description": "Globally unique name for the Azure Cosmos DB account (lowercase letters and numbers only)."
      }
    },
    "cosmosDatabaseName": {
      "type": "string",
      "defaultValue": "stellaris",
      "metadata": {
        "description": "Cosmos DB database id used by the Flowcy services."
      }
    },
    "cosmosDatabaseThroughput": {
      "type": "int",
      "defaultValue": 400,
      "minValue": 400,
      "metadata": {
        "description": "Provisioned RU/s for the Cosmos DB database. Increase for larger deployments."
      }
    },
    "devOpsOrgName": {
      "type": "string",
      "metadata": {
        "description": "Azure DevOps organization name that Flowcy will manage."
      }
    },
    "webImage": {
      "type": "string",
      "defaultValue": "moimhossain/azdo-control-panel:v2",
      "metadata": {
        "description": "Container image for the Flowcy Web API."
      }
    },
    "daemonImage": {
      "type": "string",
      "defaultValue": "moimhossain/azdo-control-panel-daemon:v2",
      "metadata": {
        "description": "Container image for the Flowcy daemon processor."
      }
    },
    "webPatSecret": {
      "type": "securestring",
      "metadata": {
        "description": "Azure DevOps PAT that the Web API will use for elevated calls."
      }
    },
    "daemonPatSecret": {
      "type": "securestring",
      "metadata": {
        "description": "Azure DevOps PAT that the daemon will use. Reuse the Web PAT if desired."
      }
    },
    "webReplicaMin": {
      "type": "int",
      "defaultValue": 1,
      "minValue": 0,
      "metadata": {
        "description": "Minimum replica count for the Web API container app."
      }
    },
    "webReplicaMax": {
      "type": "int",
      "defaultValue": 3,
      "minValue": 1,
      "metadata": {
        "description": "Maximum replica count for the Web API container app."
      }
    },
    "daemonReplicaMin": {
      "type": "int",
      "defaultValue": 1,
      "minValue": 0,
      "metadata": {
        "description": "Minimum replica count for the daemon container app."
      }
    },
    "daemonReplicaMax": {
      "type": "int",
      "defaultValue": 1,
      "minValue": 1,
      "metadata": {
        "description": "Maximum replica count for the daemon container app."
      }
    },
    "webContainerCpu": {
      "type": "string",
      "defaultValue": "1",
      "metadata": {
        "description": "CPU cores assigned to the Web API container (provide decimal values as strings, e.g., 0.5)."
      }
    },
    "webContainerMemory": {
      "type": "string",
      "defaultValue": "2Gi",
      "metadata": {
        "description": "Memory assigned to the Web API container (e.g., 1Gi, 2Gi)."
      }
    },
    "daemonContainerCpu": {
      "type": "string",
      "defaultValue": "0.5",
      "metadata": {
        "description": "CPU cores assigned to the daemon container (provide decimal values as strings, e.g., 0.5)."
      }
    },
    "daemonContainerMemory": {
      "type": "string",
      "defaultValue": "1Gi",
      "metadata": {
        "description": "Memory assigned to the daemon container (e.g., 0.5Gi, 1Gi)."
      }
    },
    "webContainerPort": {
      "type": "int",
      "defaultValue": 8080,
      "metadata": {
        "description": "Port exposed by the Web API container for HTTP ingress."
      }
    }
  },
  "variables": {
    "logAnalyticsWorkspaceName": "[format('{0}-law', parameters('namePrefix'))]",
    "containerAppsEnvironmentName": "[format('{0}-cae', parameters('namePrefix'))]",
    "webContainerAppName": "[format('{0}-api', parameters('namePrefix'))]",
    "daemonContainerAppName": "[format('{0}-daemon', parameters('namePrefix'))]",
    "logAnalyticsApiVersion": "2022-10-01",
    "cosmosApiVersion": "2023-04-15",
    "webCpu": "[json(parameters('webContainerCpu'))]",
    "daemonCpu": "[json(parameters('daemonContainerCpu'))]"
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces",
      "apiVersion": "2022-10-01",
      "name": "[variables('logAnalyticsWorkspaceName')]",
      "location": "[parameters('location')]",
      "properties": {
        "sku": {
          "name": "PerGB2018"
        },
        "retentionInDays": 30
      }
    },
    {
      "type": "Microsoft.App/managedEnvironments",
      "apiVersion": "2024-03-01",
      "name": "[variables('containerAppsEnvironmentName')]",
      "location": "[parameters('location')]",
      "properties": {
        "appLogsConfiguration": {
          "destination": "log-analytics",
          "logAnalyticsConfiguration": {
            "customerId": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsWorkspaceName')), '2022-10-01').customerId]",
            "sharedKey": "[listKeys(resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsWorkspaceName')), variables('logAnalyticsApiVersion')).primarySharedKey]"
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsWorkspaceName'))]"
      ]
    },
    {
      "type": "Microsoft.DocumentDB/databaseAccounts",
      "apiVersion": "2023-04-15",
      "name": "[parameters('cosmosAccountName')]",
      "location": "[parameters('location')]",
      "kind": "GlobalDocumentDB",
      "properties": {
        "databaseAccountOfferType": "Standard",
        "locations": [
          {
            "locationName": "[parameters('location')]",
            "failoverPriority": 0,
            "isZoneRedundant": false
          }
        ],
        "consistencyPolicy": {
          "defaultConsistencyLevel": "Session"
        },
        "publicNetworkAccess": "Enabled",
        "enableFreeTier": false
      }
    },
    {
      "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases",
      "apiVersion": "2023-04-15",
      "name": "[format('{0}/{1}', parameters('cosmosAccountName'), parameters('cosmosDatabaseName'))]",
      "properties": {
        "resource": {
          "id": "[parameters('cosmosDatabaseName')]"
        },
        "options": {
          "throughput": "[parameters('cosmosDatabaseThroughput')]"
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosAccountName'))]"
      ]
    },
    {
      "type": "Microsoft.App/containerApps",
      "apiVersion": "2024-03-01",
      "name": "[variables('webContainerAppName')]",
      "location": "[parameters('location')]",
      "properties": {
        "managedEnvironmentId": "[resourceId('Microsoft.App/managedEnvironments', variables('containerAppsEnvironmentName'))]",
        "configuration": {
          "ingress": {
            "external": true,
            "transport": "auto",
            "targetPort": "[parameters('webContainerPort')]"
          },
          "secrets": [
            {
              "name": "cosmos-conn",
              "value": "[format('AccountEndpoint={0};AccountKey={1};', reference(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosAccountName')), '2023-04-15').documentEndpoint, listKeys(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosAccountName')), variables('cosmosApiVersion')).primaryMasterKey)]"
            },
            {
              "name": "devops-pat",
              "value": "[parameters('webPatSecret')]"
            }
          ],
          "registries": [],
          "activeRevisionsMode": "Single"
        },
        "template": {
          "containers": [
            {
              "name": "web",
              "image": "[parameters('webImage')]",
              "resources": {
                "cpu": "[variables('webCpu')]",
                "memory": "[parameters('webContainerMemory')]"
              },
              "env": [
                {
                  "name": "AZURE_COSMOS_CONNECTIONSTRING",
                  "secretRef": "cosmos-conn"
                },
                {
                  "name": "AZURE_COSMOS_DATABASEID",
                  "value": "[parameters('cosmosDatabaseName')]"
                },
                {
                  "name": "AZURE_DEVOPS_ORGNAME",
                  "value": "[parameters('devOpsOrgName')]"
                },
                {
                  "name": "AZURE_DEVOPS_USE_PAT",
                  "value": "true"
                },
                {
                  "name": "AZURE_DEVOPS_USE_MANAGED_IDENTITY",
                  "value": "false"
                },
                {
                  "name": "AZURE_DEVOPS_USE_SERVICE_PRINCIPAL",
                  "value": "false"
                },
                {
                  "name": "AZURE_DEVOPS_PAT",
                  "secretRef": "devops-pat"
                }
              ]
            }
          ],
          "scale": {
            "minReplicas": "[parameters('webReplicaMin')]",
            "maxReplicas": "[parameters('webReplicaMax')]"
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.App/managedEnvironments', variables('containerAppsEnvironmentName'))]",
        "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosAccountName'))]",
        "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', parameters('cosmosAccountName'), parameters('cosmosDatabaseName'))]"
      ]
    },
    {
      "type": "Microsoft.App/containerApps",
      "apiVersion": "2024-03-01",
      "name": "[variables('daemonContainerAppName')]",
      "location": "[parameters('location')]",
      "properties": {
        "managedEnvironmentId": "[resourceId('Microsoft.App/managedEnvironments', variables('containerAppsEnvironmentName'))]",
        "configuration": {
          "secrets": [
            {
              "name": "cosmos-conn",
              "value": "[format('AccountEndpoint={0};AccountKey={1};', reference(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosAccountName')), '2023-04-15').documentEndpoint, listKeys(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosAccountName')), variables('cosmosApiVersion')).primaryMasterKey)]"
            },
            {
              "name": "daemon-devops-pat",
              "value": "[parameters('daemonPatSecret')]"
            }
          ],
          "registries": [],
          "activeRevisionsMode": "Single"
        },
        "template": {
          "containers": [
            {
              "name": "daemon",
              "image": "[parameters('daemonImage')]",
              "resources": {
                "cpu": "[variables('daemonCpu')]",
                "memory": "[parameters('daemonContainerMemory')]"
              },
              "env": [
                {
                  "name": "AZURE_COSMOS_CONNECTIONSTRING",
                  "secretRef": "cosmos-conn"
                },
                {
                  "name": "AZURE_COSMOS_DATABASEID",
                  "value": "[parameters('cosmosDatabaseName')]"
                },
                {
                  "name": "AZURE_DEVOPS_ORGNAME",
                  "value": "[parameters('devOpsOrgName')]"
                },
                {
                  "name": "AZURE_DEVOPS_USE_PAT",
                  "value": "true"
                },
                {
                  "name": "AZURE_DEVOPS_USE_MANAGED_IDENTITY",
                  "value": "false"
                },
                {
                  "name": "AZURE_DEVOPS_USE_SERVICE_PRINCIPAL",
                  "value": "false"
                },
                {
                  "name": "AZURE_DEVOPS_PAT",
                  "secretRef": "daemon-devops-pat"
                }
              ]
            }
          ],
          "scale": {
            "minReplicas": "[parameters('daemonReplicaMin')]",
            "maxReplicas": "[parameters('daemonReplicaMax')]"
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.App/managedEnvironments', variables('containerAppsEnvironmentName'))]",
        "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosAccountName'))]",
        "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', parameters('cosmosAccountName'), parameters('cosmosDatabaseName'))]"
      ]
    }
  ],
  "outputs": {
    "webAppFqdn": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.App/containerApps', variables('webContainerAppName')), '2024-03-01').configuration.ingress.fqdn]"
    },
    "daemonAppName": {
      "type": "string",
      "value": "[variables('daemonContainerAppName')]"
    },
    "cosmosEndpoint": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosAccountName')), '2023-04-15').documentEndpoint]"
    }
  }
}