{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Azure region for all resources. Defaults to the resource group's location."
      }
    },
    "namePrefix": {
      "type": "string",
      "defaultValue": "flowcy",
      "metadata": {
        "description": "Prefix used for resource names (letters, numbers, and hyphens)."
      }
    },
    "cosmosAccountName": {
      "type": "string",
      "defaultValue": "[toLower(substring(replace(concat(parameters('namePrefix'), uniqueString(resourceGroup().id)), '-', ''), 0, 44))]",
      "minLength": 3,
      "metadata": {
        "description": "Globally unique name for the Azure Cosmos DB account (lowercase letters and numbers only)."
      }
    },
    "cosmosDatabaseName": {
      "type": "string",
      "defaultValue": "stellaris",
      "metadata": {
        "description": "Cosmos DB database id used by the Flowcy services."
      }
    },
    "cosmosDatabaseThroughput": {
      "type": "int",
      "defaultValue": 400,
      "minValue": 400,
      "metadata": {
        "description": "Provisioned RU/s for the Cosmos DB database. Increase for larger deployments."
      }
    },
    "devOpsOrgName": {
      "type": "string",
      "metadata": {
        "description": "Azure DevOps organization name that Flowcy will manage."
      }
    },
    "webImage": {
      "type": "string",
      "defaultValue": "moimhossain/azdo-control-panel:v2",
      "metadata": {
        "description": "Container image for the Flowcy Web API."
      }
    },
    "daemonImage": {
      "type": "string",
      "defaultValue": "moimhossain/azdo-control-panel-daemon:v2",
      "metadata": {
        "description": "Container image for the Flowcy daemon processor."
      }
    },
    "webPatSecret": {
      "type": "secureString",
      "metadata": {
        "description": "Azure DevOps PAT that the Web API will use for elevated calls."
      }
    },
    "daemonPatSecret": {
      "type": "secureString",
      "metadata": {
        "description": "Azure DevOps PAT that the daemon will use. Reuse the Web PAT if desired."
      }
    },
    "webReplicaMin": {
      "type": "int",
      "defaultValue": 1,
      "minValue": 0,
      "metadata": {
        "description": "Minimum replica count for the Web API container app."
      }
    },
    "webReplicaMax": {
      "type": "int",
      "defaultValue": 3,
      "minValue": 1,
      "metadata": {
        "description": "Maximum replica count for the Web API container app."
      }
    },
    "daemonReplicaMin": {
      "type": "int",
      "defaultValue": 1,
      "minValue": 0,
      "metadata": {
        "description": "Minimum replica count for the daemon container app."
      }
    },
    "daemonReplicaMax": {
      "type": "int",
      "defaultValue": 1,
      "minValue": 1,
      "metadata": {
        "description": "Maximum replica count for the daemon container app."
      }
    },
    "webContainerCpu": {
      "type": "number",
      "defaultValue": 1,
      "metadata": {
        "description": "CPU cores assigned to the Web API container."
      }
    },
    "webContainerMemory": {
      "type": "string",
      "defaultValue": "2Gi",
      "metadata": {
        "description": "Memory assigned to the Web API container (e.g., 1Gi, 2Gi)."
      }
    },
    "daemonContainerCpu": {
      "type": "number",
      "defaultValue": 0.5,
      "metadata": {
        "description": "CPU cores assigned to the daemon container."
      }
    },
    "daemonContainerMemory": {
      "type": "string",
      "defaultValue": "1Gi",
      "metadata": {
        "description": "Memory assigned to the daemon container (e.g., 0.5Gi, 1Gi)."
      }
    },
    "webContainerPort": {
      "type": "int",
      "defaultValue": 8080,
      "metadata": {
        "description": "Port exposed by the Web API container for HTTP ingress."
      }
    }
  },
  "variables": {
    "logAnalyticsWorkspaceName": "[format('{0}-law', parameters('namePrefix'))]",
    "containerAppsEnvironmentName": "[format('{0}-cae', parameters('namePrefix'))]",
    "webContainerAppName": "[format('{0}-api', parameters('namePrefix'))]",
    "daemonContainerAppName": "[format('{0}-daemon', parameters('namePrefix'))]",
    "cosmosConnectionString": "[format('AccountEndpoint={0};AccountKey={1};', reference(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosAccountName')), '2023-04-15').documentEndpoint, listKeys(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosAccountName')), '2023-04-15').primaryMasterKey)]"
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces",
      "apiVersion": "2022-10-01",
      "name": "[variables('logAnalyticsWorkspaceName')]",
      "location": "[parameters('location')]",
      "properties": {
        "sku": {
          "name": "PerGB2018"
        },
        "retentionInDays": 30
      }
    },
    {
      "type": "Microsoft.App/managedEnvironments",
      "apiVersion": "2024-03-01",
      "name": "[variables('containerAppsEnvironmentName')]",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsWorkspaceName'))]"
      ],
      "properties": {
        "appLogsConfiguration": {
          "destination": "log-analytics",
          "logAnalyticsConfiguration": {
            "customerId": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsWorkspaceName')), '2022-10-01').customerId]",
            "sharedKey": "[listKeys(resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsWorkspaceName')), '2022-10-01').primarySharedKey]"
          }
        }
      }
    },
    {
      "type": "Microsoft.DocumentDB/databaseAccounts",
      "apiVersion": "2023-04-15",
      "name": "[parameters('cosmosAccountName')]",
      "location": "[parameters('location')]",
      "kind": "GlobalDocumentDB",
      "properties": {
        "databaseAccountOfferType": "Standard",
        "locations": [
          {
            "locationName": "[parameters('location')]",
            "failoverPriority": 0,
            "isZoneRedundant": false
          }
        ],
        "consistencyPolicy": {
          "defaultConsistencyLevel": "Session"
        },
        "publicNetworkAccess": "Enabled",
        "enableFreeTier": false
      }
    },
    {
      "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases",
      "apiVersion": "2023-04-15",
      "name": "[format('{0}/{1}', parameters('cosmosAccountName'), parameters('cosmosDatabaseName'))]",
      "dependsOn": [
        "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosAccountName'))]"
      ],
      "properties": {
        "resource": {
          "id": "[parameters('cosmosDatabaseName')]"
        },
        "options": {
          "throughput": "[string(parameters('cosmosDatabaseThroughput'))]"
        }
      }
    },
    {
      "type": "Microsoft.App/containerApps",
      "apiVersion": "2024-03-01",
      "name": "[variables('webContainerAppName')]",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.App/managedEnvironments', variables('containerAppsEnvironmentName'))]",
        "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', parameters('cosmosAccountName'), parameters('cosmosDatabaseName'))]"
      ],
      "properties": {
        "managedEnvironmentId": "[resourceId('Microsoft.App/managedEnvironments', variables('containerAppsEnvironmentName'))]",
        "configuration": {
          "ingress": {
            "external": true,
            "transport": "auto",
            "targetPort": [parameters('webContainerPort')]
          },
          "secrets": [
            {
              "name": "cosmos-conn",
              "value": "[variables('cosmosConnectionString')]"
            },
            {
              "name": "devops-pat",
              "value": "[parameters('webPatSecret')]"
            }
          ],
          "registries": [],
          "activeRevisionsMode": "Single"
        },
        "template": {
          "containers": [
            {
              "name": "web",
              "image": "[parameters('webImage')]",
              "resources": {
                "cpu": [parameters('webContainerCpu')],
                "memory": "[parameters('webContainerMemory')]"
              },
              "env": [
                {
                  "name": "AZURE_COSMOS_CONNECTIONSTRING",
                  "valueSecretRef": "cosmos-conn"
                },
                {
                  "name": "AZURE_COSMOS_DATABASEID",
                  "value": "[parameters('cosmosDatabaseName')]"
                },
                {
                  "name": "AZURE_DEVOPS_ORGNAME",
                  "value": "[parameters('devOpsOrgName')]"
                },
                {
                  "name": "AZURE_DEVOPS_USE_PAT",
                  "value": "true"
                },
                {
                  "name": "AZURE_DEVOPS_USE_MANAGED_IDENTITY",
                  "value": "false"
                },
                {
                  "name": "AZURE_DEVOPS_USE_SERVICE_PRINCIPAL",
                  "value": "false"
                },
                {
                  "name": "AZURE_DEVOPS_PAT",
                  "valueSecretRef": "devops-pat"
                }
              ]
            }
          ],
          "scale": {
            "minReplicas": [parameters('webReplicaMin')],
            "maxReplicas": [parameters('webReplicaMax')]
          }
        }
      }
    },
    {
      "type": "Microsoft.App/containerApps",
      "apiVersion": "2024-03-01",
      "name": "[variables('daemonContainerAppName')]",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.App/managedEnvironments', variables('containerAppsEnvironmentName'))]",
        "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', parameters('cosmosAccountName'), parameters('cosmosDatabaseName'))]"
      ],
      "properties": {
        "managedEnvironmentId": "[resourceId('Microsoft.App/managedEnvironments', variables('containerAppsEnvironmentName'))]",
        "configuration": {
          "secrets": [
            {
              "name": "cosmos-conn",
              "value": "[variables('cosmosConnectionString')]"
            },
            {
              "name": "daemon-devops-pat",
              "value": "[parameters('daemonPatSecret')]"
            }
          ],
          "registries": [],
          "activeRevisionsMode": "Single"
        },
        "template": {
          "containers": [
            {
              "name": "daemon",
              "image": "[parameters('daemonImage')]",
              "resources": {
                "cpu": [parameters('daemonContainerCpu')],
                "memory": "[parameters('daemonContainerMemory')]"
              },
              "env": [
                {
                  "name": "AZURE_COSMOS_CONNECTIONSTRING",
                  "valueSecretRef": "cosmos-conn"
                },
                {
                  "name": "AZURE_COSMOS_DATABASEID",
                  "value": "[parameters('cosmosDatabaseName')]"
                },
                {
                  "name": "AZURE_DEVOPS_ORGNAME",
                  "value": "[parameters('devOpsOrgName')]"
                },
                {
                  "name": "AZURE_DEVOPS_USE_PAT",
                  "value": "true"
                },
                {
                  "name": "AZURE_DEVOPS_USE_MANAGED_IDENTITY",
                  "value": "false"
                },
                {
                  "name": "AZURE_DEVOPS_USE_SERVICE_PRINCIPAL",
                  "value": "false"
                },
                {
                  "name": "AZURE_DEVOPS_PAT",
                  "valueSecretRef": "daemon-devops-pat"
                }
              ]
            }
          ],
          "scale": {
            "minReplicas": [parameters('daemonReplicaMin')],
            "maxReplicas": [parameters('daemonReplicaMax')]
          }
        }
      }
    }
  ],
  "outputs": {
    "webAppFqdn": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.App/containerApps', variables('webContainerAppName')), '2024-03-01').properties.configuration.ingress.fqdn]"
    },
    "daemonAppName": {
      "type": "string",
      "value": "[variables('daemonContainerAppName')]"
    },
    "cosmosEndpoint": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosAccountName')), '2023-04-15').documentEndpoint]"
    }
  }
}
